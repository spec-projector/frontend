<ul filling>
    <li *ngIf="feature.story.length" story></li>
    <li *ngIf="feature.frames.length" frames></li>
    <li *ngIf="feature.graphql.length" graphql></li>
</ul>

<jnt-label *ngIf="(feature | featurePrice:feature.version:feature.rev) as price"
           price
           [color]="ui.colors.gray300"
           [label]="price | currency"></jnt-label>

<form [formGroup]="form">
    <header (mouseenter)="manager.mode ==  editMode.edit ? mode = editMode.edit : null"
            (mouseleave)="mode = editMode.view">
        <ng-container *ngIf="mode == editMode.edit; else viewHeader">
            <input title formControlName="title" fitWidth>
        </ng-container>
    </header>

    <ng-template #viewHeader>
        <spec-tokens title [spec]="feature.spec"
                     [tokens]="feature.title"></spec-tokens>
    </ng-template>


    <jnt-stack>
        <jnt-stack [type]="ui.stack.type.horizontal" [gutter]="ui.gutter.small">
            <jnt-button [scheme]="ui.schemes.secondary"
                        [icon]="opened ? ui.icons.chevronUp : ui.icons.chevronDown"
                        [size]="ui.sizes.tiny"
                        (click)="opened = !opened">
            </jnt-button>
            <jnt-button [scheme]="ui.schemes.secondary" [icon]="ui.icons.copy"
                        [size]="ui.sizes.tiny"
                        (click)="copyMarkdown()"></jnt-button>
            <!--<spec-issue *ngFor="let issue of feature.issues" [issue]="issue"></spec-issue>-->
        </jnt-stack>

        <spec-feature-markdown #summary [feature]="feature"
                               [style.display]="markdown ? 'block' : 'none'"></spec-feature-markdown>
        <ng-container *ngIf="opened">
            <jnt-stack>
                <jnt-tabs>
                    <jnt-tab title="User story" [active]="true">
                        <ng-container *ngIf="feature.story.length;else addStoryTemplate">
                            <ol (mouseenter)="manager.mode ==  editMode.edit ? storyMode = editMode.edit : null"
                                (mouseleave)="storyMode = editMode.view">
                                <li *ngFor="let entry of feature.story; let i = index">
                                    <spec-story-entry #storyEntry [entry]="entry"
                                                      [mode]="storyMode"
                                                      [spec]="feature.spec"
                                                      (changed)="manager.put(feature)"
                                                      (finished)="addStoryEntry(i)"
                                                      (deleted)="deleteStoryEntry(i)">
                                    </spec-story-entry>
                                </li>
                            </ol>
                        </ng-container>

                        <ng-template #addStoryTemplate>
                            <div>
                                <jnt-link title="Add story" (click)="addStory()"></jnt-link>
                                here
                            </div>
                        </ng-template>
                    </jnt-tab>
                    <jnt-tab title="Resources">
                        <spec-feature-resources [feature]="feature"
                                                (changed)="saveResources($event)">
                        </spec-feature-resources>
                    </jnt-tab>
                </jnt-tabs>

                <table>
                    <thead>
                    <th style="width:35%">Frontend</th>
                    <th width="10"></th>
                    <th style="width:30%">API</th>
                    <th width="10"></th>
                    <th style="width:35%">Backend</th>
                    </thead>
                    <tr>
                        <td frontend>
                            <jnt-button add [size]="ui.sizes.tiny"
                                        [icon]="ui.icons.plus"
                                        [jntPopover]="{title: 'Add frame', content: addFrameTemplate, trigger: ui.popover.trigger.click}"></jnt-button>
                            <ng-template #addFrameTemplate>
                                <spec-feature-add-frame [feature]="feature"
                                                        (added)="addFrame($event)"></spec-feature-add-frame>
                            </ng-template>
                            <ul frames>
                                <li *ngFor="let frame of feature.frames; let i = index">
                                    <ng-container
                                            *ngIf="this.storage.get(frame.file, frame.node) as render;else loading">
                                        <img *ngIf="render['thumbnail'] as thumbnail;else generateRenderTemplate"
                                             [src]="thumbnail">
                                        <ng-template #generateRenderTemplate>
                                            <jnt-spinner></jnt-spinner>
                                        </ng-template>
                                    </ng-container>
                                    <ng-template #loading>
                                        {{preview(frame.file, frame.node)}}
                                    </ng-template>
                                    <jnt-link figma
                                              [outline]="ui.outline.fill"
                                              title="Figma"
                                              target="_blank"
                                              [icon]="ui.icons.figma"
                                              [source]="'http://figma.com/file/' + frame.file + '?node-id=' + frame.node"></jnt-link>
                                    <jnt-button delete [scheme]="ui.schemes.secondary"
                                                [icon]="ui.icons.delete"
                                                (click)="removeFrame(i)"></jnt-button>
                                </li>
                            </ul>
                        </td>
                        <td>
                            <jnt-icon [icon]="ui.icons.arrowRight"></jnt-icon>
                        </td>
                        <td>
                            <jnt-stack>
                                <jnt-dropdown>
                                    <ng-template #trigger let-action="trigger">
                                        <jnt-button [icon]="ui.icons.plus"
                                                    [size]="ui.sizes.tiny"
                                                    (click)="action()"></jnt-button>
                                    </ng-template>
                                    <ng-template #dropdown let-action="trigger">
                                        <jnt-menu [type]="ui.type.vertical" [spacer]="ui.sizes.tiny">
                                            <jnt-menu-item title="Graph QL"
                                                           (click)="addGraphQL();action();"></jnt-menu-item>
                                            <jnt-menu-item title="REST API" (click)="action()"></jnt-menu-item>
                                        </jnt-menu>
                                    </ng-template>
                                </jnt-dropdown>
                                <jnt-label api *ngFor="let query of feature.graphql;let i = index;"
                                           [icon]="ui.icons.solar"
                                           [label]="query.title"
                                           (click)="editGraphQL(query, i)"></jnt-label>
                            </jnt-stack>
                        </td>
                        <td>
                            <jnt-icon [icon]="ui.icons.arrowLeft"></jnt-icon>
                        </td>
                        <td>
                            <jnt-label *ngFor="let entity of feature.entities"
                                       [label]="entity.title"></jnt-label>
                        </td>
                    </tr>
                </table>
            </jnt-stack>
        </ng-container>
    </jnt-stack>
</form>

